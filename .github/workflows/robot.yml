name: Robot Framework Tests (Edge)
on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install robotframework selenium>=4.10.0 robotframework-seleniumlibrary

      - name: Install Microsoft Edge and WebDriver
        run: |
            # 1. Instala o Microsoft Edge
            echo "Instalando Microsoft Edge..."
            curl -fsSL https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > microsoft.gpg
            sudo install -o root -g root -m 644 microsoft.gpg /usr/share/keyrings/microsoft-archive-keyring.gpg
            sudo sh -c 'echo "deb [arch=amd64 signed-by=/usr/share/keyrings/microsoft-archive-keyring.gpg] https://packages.microsoft.com/repos/edge stable main" > /etc/apt/sources.list.d/microsoft-edge.list'
            sudo apt update
            sudo apt install -y microsoft-edge-stable
        
            # 2. Obt√©m a vers√£o principal do Edge (ex: 135 para 135.0.3179.85)
            EDGE_MAJOR_VERSION=$(microsoft-edge --version | awk -F. '{print $1}' | awk '{print $3}')
            echo "Vers√£o principal do Edge: $EDGE_MAJOR_VERSION"
        
            # 3. Tenta obter a vers√£o est√°vel mais recente do WebDriver
            echo "Buscando vers√£o est√°vel do WebDriver..."
            DRIVER_VERSION=$(curl -s "https://msedgedriver.azureedge.net/LATEST_STABLE_$EDGE_MAJOR_VERSION" || curl -s "https://msedgedriver.azureedge.net/LATEST_RELEASE_$EDGE_MAJOR_VERSION")
            echo "Vers√£o do WebDriver: $DRIVER_VERSION"
        
            # 4. Baixa e instala o WebDriver
            echo "Baixando WebDriver..."
            wget -q "https://msedgedriver.azureedge.net/$DRIVER_VERSION/edgedriver_linux64.zip"
            unzip -o edgedriver_linux64.zip
            sudo mv msedgedriver /usr/local/bin/
            sudo chmod +x /usr/local/bin/msedgeddriver
            rm edgedriver_linux64.zip
        
            # 5. Verifica a instala√ß√£o
            echo "Verificando instala√ß√µes..."
            microsoft-edge --version
            msedgedriver --version

      - name: Run Robot Tests
        run: |
          robot --variable BROWSER:Edge --outputdir results/ tests/

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        with: 
          name: robot-reports
          path: results/

  report:
        name: Report Tests üåê
        runs-on: ubuntu-24.04
        if: always()
        needs: 
          - tests
    
        permissions:
          contents: read
          pages: write
          id-token: write
        environment:
          name: github-pages
          url: https://clestonv.github.io/robot-basic-tqa13/report.html

        steps:
          - name: Configura√ß√£o do Site do Resultado do Testes
            uses: actions/configure-pages@v4

          - name: Download Resultado dos Testes
            uses: actions/download-artifact@v4
            with:
              name: resultado-testes
              path: results/

          - name: Upload dos Resultados
            uses: actions/upload-pages-artifact@v3
            with:
              path: results/

          - name: Subindo Pagina de Resultados dos Testes üöÄ
            id: deployment
            uses: actions/deploy-pages@v4